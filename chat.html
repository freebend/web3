<script>
/* === Help-Chat Widget Snippet (clean) ================================== */
(() => {
  const API  = 'https://mct6.47008-eth.workers.dev';           // <- change
  const KEY  = 'cf_chat_room';                              // localStorage key

  /* ---------- tiny helpers ---------- */
  const log = (...a) => console.log('[chat]', ...a);
  const rand = () => Math.random().toString(36).substr(2, 8).toUpperCase();

  /* ---------- UI ---------- */
  const css = `
    #chat-btn{position:fixed;bottom:20px;right:20px;z-index:9999;padding:10px 18px;border:0;border-radius:20px;background:#0077ff;color:#fff;cursor:pointer}
    #chat-box{display:none;flex-direction:column;position:fixed;bottom:70px;right:20px;width:300px;height:400px;border:1px solid #ccc;border-radius:8px;background:#fff;overflow:hidden}
    #chat-msgs{flex:1;padding:8px;overflow-y:auto;font-size:13px}
    #chat-form{display:flex;border-top:1px solid #eee}
    #chat-input{flex:1;padding:5px;border:0}
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.append(style);

  const btn   = document.createElement('button');
  btn.id = 'chat-btn';
  btn.textContent = 'ðŸ’¬';
  document.body.append(btn);

  const box   = document.createElement('div');
  box.id = 'chat-box';
  box.innerHTML = `
    <div id="chat-msgs"></div>
    <form id="chat-form"><input id="chat-input" placeholder="Typeâ€¦" autocomplete="off"></form>
  `;
  document.body.append(box);

  /* ---------- state ---------- */
  let roomId = localStorage.getItem(KEY);
  let ws;

  /* ---------- functions ---------- */
  function addMsg(txt, who='system') {
    const d=document.createElement('div');
    d.innerHTML=`<b>${who}:</b> ${txt}`;
    chatMsgs.appendChild(d);
    chatMsgs.scrollTop=chatMsgs.scrollHeight;
  }
  async function openRoom() {
    if (!roomId) {
      const res = await fetch(`${API}/newRoom`, {method:'POST'});
      roomId = (await res.json()).roomId;
      localStorage.setItem(KEY, roomId);
    }
    ws = new WebSocket(`${API.replace('https','wss')}/ws/${roomId}`);
    ws.onopen   = ()=>addMsg('Connected');
    ws.onclose  = ()=>setTimeout(openRoom, 2000);
    ws.onmessage= e=>{
      const m = JSON.parse(e.data);
      if (m.text) addMsg(m.text, m.from||'agent');
    };
  }
  function toggle() {
    box.style.display = box.style.display==='flex'?'none':'flex';
    if (!ws) openRoom();
  }

  /* ---------- events ---------- */
  btn.onclick = toggle;
  chatForm.onsubmit = e=>{
    e.preventDefault();
    const txt = chatInput.value.trim();
    if (!txt) return;
    ws.send(JSON.stringify({text:txt}));
    addMsg(txt,'you');
    chatInput.value='';
  };
})();
</script>
